{% extends 'base.html' %}
{% load static %}

{# ======================== TITLE BLOCK ======================== #}
{% block title %}{{ memorial.first_name }} {{ memorial.last_name }} - Memorial{% endblock %}

{# ======================== MAIN CONTENT BLOCK ======================== #}
{% block content %}
  {# ------------------------ Custom CSS ------------------------ #}
<link rel="stylesheet" href="{% static 'css/memorials/memorial_detail.css' %}">

  {# ------------------------ Flash Messages ------------------------ #}
  {% if messages %}
    <div class="container mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" 
             role="alert">
          {{ message }}
          <button type="button" 
                  class="btn-close" 
                  data-bs-dismiss="alert" 
                  aria-label="Close">
          </button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# ------------------------ Memorial Banner ------------------------ #}
  {% if memorial.banner_type == 'image' and memorial.banner_value %}
    <div id="memorialBanner" 
         class="banner banner-image"
         data-memorial-id="{{ memorial.pk }}"
         style="background-image: url('{% static memorial.banner_value %}');">
  {% elif memorial.banner_type == 'color' and memorial.banner_value %}
    <div id="memorialBanner" 
         class="banner banner-color"
         data-memorial-id="{{ memorial.pk }}"
         style="background-color: {{ memorial.banner_value }};">
  {% else %}
    <div id="memorialBanner" 
         class="banner banner-default"
         data-memorial-id="{{ memorial.pk }}">
  {% endif %}
    </div>

{# ------------------------ Profile Picture Section ------------------------ #}
  <div id="pfpUploadForm">
    <div class="profile-pic-wrapper upload-wrapper" 
         title="profile picture" 
         data-bs-toggle="modal" 
         data-bs-target="#profilePictureModal">
      {% if memorial.profile_public_id %}
        <img src="https://res.cloudinary.com/dols0zev1/image/upload/{{ memorial.profile_public_id }}.png?{% now 'U' %}" 
             alt="Profile Picture of {{ memorial.first_name }}" 
             class="profile-image-clickable"
             data-original-src="https://res.cloudinary.com/dols0zev1/image/upload/{{ memorial.profile_public_id }}.png">
      {% else %}
        <img src="{% static 'images/nf.png' %}" 
             alt="Default memorial image" 
             class="profile-image-clickable"
             data-original-src="{% static 'images/nf.png' %}">
      {% endif %}
    </div>
  </div>

  {# ------------------------ Profile Picture Modal ------------------------ #}
  <div class="modal fade" 
       id="profilePictureModal" 
       tabindex="-1" 
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 bg-transparent">
        <div class="modal-body text-center p-0">
          <button type="button" 
                  class="btn-close btn-close-white position-absolute top-0 end-0 m-2" 
                  data-bs-dismiss="modal" 
                  aria-label="Close">
          </button>
          {% if memorial.profile_public_id %}
            <img src="https://res.cloudinary.com/neverforgotten/image/upload/{{ memorial.profile_public_id }}.png" 
                 class="img-fluid rounded" 
                 alt="Enlarged profile picture of {{ memorial.first_name }}">
          {% else %}
            <img src="{% static 'images/nf.png' %}" 
                 class="img-fluid rounded" 
                 alt="Enlarged default memorial image">
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <br>

  {# ------------------------ Name and Dates Section ------------------------ #}
  <div class="container text-center mt-0" style="margin-bottom: 20px;">
    <h1 class="fw-bold">
      {{ memorial.first_name }} 
      {% if memorial.middle_name %}{{ memorial.middle_name }} {% endif %}
      {{ memorial.last_name }}
    </h1>
    
    {# Dates with inline icons #}
    <div id="editable-dates">
      {# Birth date with cake icon #}
      <span class="birth-date">
        <i class="fas fa-birthday-cake"></i>
        {{ memorial.date_of_birth|date:"F j, Y" }}
      </span>
      
      {# Separator #}
      <span class="date-separator">-</span>
      
      {# Death date with cross icon #}
      <span class="death-date">
        <i class="fas fa-cross"></i>
        {{ memorial.date_of_death|date:"F j, Y" }}
      </span>
    </div>
  </div>

  {# ------------------------ Button Container - Side by Side ------------------------ #}
  <div class="d-flex justify-content-center align-items-center my-4 flex-wrap">
    {# Share Button #}
    <button id="shareButton" class="btn share-button me-3">
      <i class="fas fa-share-alt me-2"></i> Share Memorial
    </button>

    {# Edit Memorial Button (for owner) #}
    {% if request.user == memorial.user %}
      <a href="{% url 'memorials:memorial_edit' pk=memorial.pk %}" 
         class="btn view-btn">
        <i class="fas fa-edit me-2"></i> Edit Memorial
      </a>
    {% endif %}
  </div>

  {# ------------------------ Quote Section ------------------------ #}
  <div class="quote-container container text-center my-5">
    <blockquote class="memorial-quote">
      <div class="quote-content-wrapper">
        <i class="fas fa-quote-left quote-icon quote-top-left"></i>
        <p class="quote-text">
          {% if memorial.quote %}
            {{ memorial.quote }}
          {% else %}
            In Loving Memory of {{ memorial.first_name }}
          {% endif %}
        </p>
        <i class="fas fa-quote-right quote-icon quote-bottom-right"></i>
      </div>
      {% if memorial.quote_author %}
        <footer class="blockquote-footer mt-3">
          <cite>{{ memorial.quote_author }}</cite>
        </footer>
      {% endif %}
    </blockquote>
  </div>

  {# ------------------------ Biography Section ------------------------ #}
  <div class="biography-container container text-left mt-4">
    <h2 class="biography-title">Remembering {{ memorial.first_name }}</h2>
    <div class="biography-divider"></div>
    <div class="mt-3 biography-text">
      {% if memorial.biography %}
        {{ memorial.biography|linebreaksbr }}
      {% else %}
        <p class="biography-placeholder">
          <i class="far fa-heart"></i>
          {{ memorial.first_name }}'s life story has not been shared yet.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- ======================= -->
<!-- TRIBUTES SECTION -->
<!-- ======================= -->
<section class="tributes-section py-5" data-memorial-id="{{ memorial.id }}">
  <div class="container">
    <div class="section-header d-flex justify-content-between align-items-center mb-4">
      <h2 class="section-title mb-0">
        <i class="fas fa-heart me-2 text-primary"></i>Tributes
      </h2>
      {% if user.is_authenticated %}
      <button type="button" class="btn btn-primary" id="open-tribute-form">
        <i class="fas fa-plus me-2"></i>Leave a Tribute
      </button>
      {% else %}
      <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-outline-primary">
        <i class="fas fa-sign-in-alt me-2"></i>Login to Leave a Tribute
      </a>
      {% endif %}
    </div>

    <div id="tribute-list" class="row g-4">
      {% with visible_tributes=tributes|slice:":3" hidden_tributes=tributes|slice:"3:" %}
      
      <!-- Visible Tributes (first 3) -->
      <div id="visible-tributes" class="row g-4">
        {% for tribute in visible_tributes %}
          {% if tribute.status == 'approved' or tribute.user == request.user %}
          <div class="col-12 tribute-item" data-tribute-id="{{ tribute.id }}" data-status="{{ tribute.status }}">
            <div class="card tribute-card h-100 border-0 shadow-sm {% if tribute.status == 'pending' %}tribute-pending{% endif %}">
              <div class="card-body d-flex flex-column p-4">
                
                {% if tribute.status == 'pending' and tribute.user == request.user %}
                <div class="pending-notice mb-3">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i> Awaiting Approval
                  </span>
                  <small class="text-muted d-block mt-1">
                    Only you can see this tribute until it's approved.
                  </small>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="tribute-author d-flex align-items-center">
                    <div class="author-avatar me-3">
                      <i class="fas fa-user"></i>
                    </div>
                    <div class="author-info">
                      <h3 class="card-title mb-0 fs-5 fw-semibold">{{ tribute.author_name }}</h3>
                      <small class="text-muted">{{ tribute.created_at|date:"M d, Y" }}</small>
                    </div>
                  </div>
                </div>
                
                <div class="card-text flex-grow-1 mb-3 lh-base tribute-message">
                  {{ tribute.message|linebreaks }}
                </div>
                
                {% if tribute.user == request.user %}
                <div class="mt-auto pt-3 border-top tribute-actions">
                  <button class="btn btn-sm btn-outline-primary edit-tribute me-2" 
                          data-tribute-id="{{ tribute.id }}"
                          data-author-name="{{ tribute.author_name }}"
                          data-message="{{ tribute.message }}"
                          aria-label="Edit tribute">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-tribute" 
                          data-tribute-id="{{ tribute.id }}"
                          aria-label="Delete tribute">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        {% empty %}
          <div class="col-12" id="empty-tributes-message">
            <div class="empty-tributes text-center py-5">
              <i class="fas fa-heart fa-3x text-muted mb-4" style="opacity: 0.3;"></i>
              <h3 class="h5 text-muted mb-3">No tributes yet</h3>
              <p class="text-muted mb-4">Be the first to share your memories and pay tribute.</p>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Hidden Tributes (after first 3) -->
      {% if hidden_tributes %}
      <div id="hidden-tributes" class="row g-4 d-none">
        {% for tribute in hidden_tributes %}
          {% if tribute.status == 'approved' or tribute.user == request.user %}
          <div class="col-12 tribute-item tribute-hidden" data-tribute-id="{{ tribute.id }}" data-status="{{ tribute.status }}">
            <div class="card tribute-card h-100 border-0 shadow-sm {% if tribute.status == 'pending' %}tribute-pending{% endif %}">
              <div class="card-body d-flex flex-column p-4">
                
                {% if tribute.status == 'pending' and tribute.user == request.user %}
                <div class="pending-notice mb-3">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i> Awaiting Approval
                  </span>
                  <small class="text-muted d-block mt-1">
                    Only you can see this tribute until it's approved.
                  </small>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="tribute-author d-flex align-items-center">
                    <div class="author-avatar me-3">
                      <i class="fas fa-user"></i>
                    </div>
                    <div class="author-info">
                      <h3 class="card-title mb-0 fs-5 fw-semibold">{{ tribute.author_name }}</h3>
                      <small class="text-muted">{{ tribute.created_at|date:"M d, Y" }}</small>
                    </div>
                  </div>
                </div>
                
                <div class="card-text flex-grow-1 mb-3 lh-base tribute-message">
                  {{ tribute.message|linebreaks }}
                </div>
                
                {% if tribute.user == request.user %}
                <div class="mt-auto pt-3 border-top tribute-actions">
                  <button class="btn btn-sm btn-outline-primary edit-tribute me-2" 
                          data-tribute-id="{{ tribute.id }}"
                          data-author-name="{{ tribute.author_name }}"
                          data-message="{{ tribute.message }}"
                          aria-label="Edit tribute">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-tribute" 
                          data-tribute-id="{{ tribute.id }}"
                          aria-label="Delete tribute">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <!-- Toggle Button -->
      <div class="col-12 text-center mt-4" id="tribute-toggle-container">
        <button type="button" class="btn btn-outline-primary" id="toggle-tributes-btn">
          <i class="fas fa-chevron-down me-2"></i>View All Tributes
        </button>
      </div>
      {% endif %}
      
      {% endwith %}
    </div>
  </div>
</section>

<!-- Create Tribute Modal -->
<div class="modal fade" id="tributeFormModal" tabindex="-1" aria-labelledby="tributeFormModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="tributeFormModalLabel">
          <i class="fas fa-heart me-2 text-primary"></i>Leave a Tribute
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="tribute-form" method="POST">
          {% csrf_token %}
          <div class="mb-3">
            <label for="tribute-author-name" class="form-label">Your Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="tribute-author-name" name="author_name" 
                   placeholder="Enter your name" required maxlength="200">
          </div>
          <div class="mb-3">
            <label for="tribute-message" class="form-label">Your Tribute <span class="text-danger">*</span></label>
            <textarea class="form-control" id="tribute-message" name="message" rows="5" 
                      placeholder="Share your memories or a message..." required maxlength="2000"></textarea>
            <div class="form-text">Maximum 2000 characters</div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane me-2"></i>Submit Tribute
            </button>
          </div>
          <p class="text-muted small mt-3 mb-0 text-center">
            <i class="fas fa-info-circle me-1"></i>
            Your tribute will be reviewed before appearing publicly.
          </p>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Tribute Modal -->
<div class="modal fade" id="editTributeModal" tabindex="-1" aria-labelledby="editTributeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="editTributeModalLabel">
          <i class="fas fa-edit me-2 text-primary"></i>Edit Tribute
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-tribute-form" method="POST">
          {% csrf_token %}
          <input type="hidden" id="edit-tribute-id" name="tribute_id">
          <div class="mb-3">
            <label for="edit-tribute-author-name" class="form-label">Your Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="edit-tribute-author-name" name="author_name" 
                   required maxlength="200">
          </div>
          <div class="mb-3">
            <label for="edit-tribute-message" class="form-label">Your Tribute <span class="text-danger">*</span></label>
            <textarea class="form-control" id="edit-tribute-message" name="message" rows="5" 
                      required maxlength="2000"></textarea>
            <div class="form-text">Maximum 2000 characters</div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


  {# ======================== MUSIC SECTION ======================== #}
  {% if memorial.plan and memorial.plan.name|lower != 'free' %}
    <div class="music-section container text-center mt-4">
      <h2 class="music-title">Memorial Music</h2>

      {% if memorial.audio_file %}
        <audio controls class="mt-3">
          <source src="{{ memorial.audio_file.url }}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
      {% else %}
        <p class="text-muted mt-3">No music has been added to this memorial.</p>
      {% endif %}
    </div>
  {% endif %}

  {# ======================== GALLERY SECTION ======================== #}
  <section class="gallery-section container mt-5 p-4 rounded-3 shadow-sm bg-light">
    <h2 class="gallery-title fs-3 fw-bold text-dark mb-4 text-center">Photo Gallery</h2>

    <div class="gallery-container">
      {# Visible photos (first 3) #}
      <div class="row g-3" id="visible-gallery">
        {% for image in memorial.gallery.all|slice:":3" %}
          <div class="col-12 col-md-4">
            <div class="gallery-item position-relative rounded overflow-hidden shadow-sm">
              <a href="#" 
                 data-bs-toggle="modal" 
                 data-bs-target="#galleryModal" 
                 data-bs-slide-to="{{ forloop.counter0 }}">
                <img src="{{ image.image.url }}" 
                     alt="{{ image.caption|default:'Gallery Image' }}" 
                     class="img-fluid gallery-img" 
                     loading="lazy">
              </a>
              {% if image.caption %}
                <div class="gallery-caption px-2 py-1 bg-dark bg-opacity-50 text-white position-absolute bottom-0 w-100 text-truncate">
                  {{ image.caption }}
                </div>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p class="text-center text-muted fst-italic">
            No photos have been added to the gallery yet.
          </p>
        {% endfor %}
      </div>

      {# Hidden additional photos #}
      <div class="row g-3 d-none" id="hidden-gallery">
        {% for image in memorial.gallery.all|slice:"3:" %}
          <div class="col-12 col-md-4">
            <div class="gallery-item position-relative rounded overflow-hidden shadow-sm">
              <a href="#" 
                 data-bs-toggle="modal" 
                 data-bs-target="#galleryModal" 
                 data-bs-slide-to="{{ forloop.counter0|add:'3' }}">
                <img src="{{ image.image.url }}" 
                     alt="{{ image.caption|default:'Gallery Image' }}" 
                     class="img-fluid gallery-img" 
                     loading="lazy">
              </a>
              {% if image.caption %}
                <div class="gallery-caption px-2 py-1 bg-dark bg-opacity-50 text-white position-absolute bottom-0 w-100 text-truncate">
                  {{ image.caption }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {# View More Button #}
    <div class="text-center mt-4">
      {% if memorial.gallery.all|length > 3 %}
        <button id="toggle-gallery-btn" class="btn btn-secondary rounded-pill px-4">
          <i class="fas fa-chevron-down me-2"></i>View More
        </button>
      {% endif %}
    </div>
  </section>

  {# ------------------------ Gallery Carousel Modal ------------------------ #}
  <div class="modal fade" 
       id="galleryModal" 
       tabindex="-1" 
       aria-labelledby="galleryModalLabel" 
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="galleryModalLabel">Photo Gallery</h5>
          <button type="button" 
                  class="btn-close btn-close-white" 
                  data-bs-dismiss="modal" 
                  aria-label="Close">
          </button>
        </div>
        <div class="modal-body p-0">
          <div id="galleryCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% for image in memorial.gallery.all %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <img src="{{ image.image.url }}" 
                       class="d-block w-100" 
                       alt="{{ image.caption|default:'Gallery Image' }}">
                  {% if image.caption %}
                    <div class="carousel-caption d-none d-md-block">
                      <p>{{ image.caption }}</p>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" 
                    type="button" 
                    data-bs-target="#galleryCarousel" 
                    data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" 
                    type="button" 
                    data-bs-target="#galleryCarousel" 
                    data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

 <!-- ======================= -->
<!-- STORIES SECTION -->
<!-- ======================= -->
<section class="stories-section py-5 bg-light" data-memorial-id="{{ memorial.id }}">
  <div class="container">
    <div class="section-header d-flex justify-content-between align-items-center mb-4">
      <h2 class="section-title mb-0">
        <i class="fas fa-book-open me-2 text-primary"></i>Stories & Memories
      </h2>
      {% if user.is_authenticated %}
      <button type="button" class="btn btn-primary" id="open-story-form">
        <i class="fas fa-plus me-2"></i>Share a Story
      </button>
      {% else %}
      <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-outline-primary">
        <i class="fas fa-sign-in-alt me-2"></i>Login to Share a Story
      </a>
      {% endif %}
    </div>

    <div id="story-list" class="row g-4">
      {% with visible_stories=stories|slice:":3" hidden_stories=stories|slice:"3:" %}
      
      <!-- Visible Stories (first 3) -->
      <div id="visible-stories" class="row g-4">
        {% for story in visible_stories %}
          {% if story.status == 'approved' or story.user == request.user %}
          <div class="col-12 story-item" data-story-id="{{ story.id }}" data-status="{{ story.status }}">
            <div class="card story-card h-100 border-0 shadow-sm {% if story.status == 'pending' %}story-pending{% endif %}">
              <div class="card-body d-flex flex-column p-4">
                
                {% if story.status == 'pending' and story.user == request.user %}
                <div class="pending-notice mb-3">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i> Awaiting Approval
                  </span>
                  <small class="text-muted d-block mt-1">
                    Only you can see this story until it's approved.
                  </small>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="story-header-info">
                    <h3 class="card-title mb-1 fs-5 fw-semibold story-title-text">{{ story.title }}</h3>
                    <p class="text-muted mb-0 story-author-text">
                      <i class="fas fa-user me-1"></i> by {{ story.author_name }}
                    </p>
                  </div>
                  <small class="text-muted story-date">{{ story.created_at|date:"M d, Y" }}</small>
                </div>
                
                <div class="card-text flex-grow-1 mb-3 lh-base story-content">
                  {{ story.content|linebreaks }}
                </div>
                
                {% if story.user == request.user %}
                <div class="mt-auto pt-3 border-top story-actions">
                  <button class="btn btn-sm btn-outline-primary edit-story me-2" 
                          data-story-id="{{ story.id }}"
                          data-author-name="{{ story.author_name }}"
                          data-title="{{ story.title }}"
                          data-content="{{ story.content }}"
                          aria-label="Edit story">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-story" 
                          data-story-id="{{ story.id }}"
                          aria-label="Delete story">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        {% empty %}
          <div class="col-12" id="empty-stories-message">
            <div class="empty-stories text-center py-5">
              <i class="fas fa-book-open fa-3x text-muted mb-4" style="opacity: 0.3;"></i>
              <h3 class="h5 text-muted mb-3">No stories yet</h3>
              <p class="text-muted mb-4">Be the first to share a story or memory.</p>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Hidden Stories (after first 3) -->
      {% if hidden_stories %}
      <div id="hidden-stories" class="row g-4 d-none">
        {% for story in hidden_stories %}
          {% if story.status == 'approved' or story.user == request.user %}
          <div class="col-12 story-item story-hidden" data-story-id="{{ story.id }}" data-status="{{ story.status }}">
            <div class="card story-card h-100 border-0 shadow-sm {% if story.status == 'pending' %}story-pending{% endif %}">
              <div class="card-body d-flex flex-column p-4">
                
                {% if story.status == 'pending' and story.user == request.user %}
                <div class="pending-notice mb-3">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i> Awaiting Approval
                  </span>
                  <small class="text-muted d-block mt-1">
                    Only you can see this story until it's approved.
                  </small>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="story-header-info">
                    <h3 class="card-title mb-1 fs-5 fw-semibold story-title-text">{{ story.title }}</h3>
                    <p class="text-muted mb-0 story-author-text">
                      <i class="fas fa-user me-1"></i> by {{ story.author_name }}
                    </p>
                  </div>
                  <small class="text-muted story-date">{{ story.created_at|date:"M d, Y" }}</small>
                </div>
                
                <div class="card-text flex-grow-1 mb-3 lh-base story-content">
                  {{ story.content|linebreaks }}
                </div>
                
                {% if story.user == request.user %}
                <div class="mt-auto pt-3 border-top story-actions">
                  <button class="btn btn-sm btn-outline-primary edit-story me-2" 
                          data-story-id="{{ story.id }}"
                          data-author-name="{{ story.author_name }}"
                          data-title="{{ story.title }}"
                          data-content="{{ story.content }}"
                          aria-label="Edit story">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-story" 
                          data-story-id="{{ story.id }}"
                          aria-label="Delete story">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <!-- Toggle Button -->
      <div class="col-12 text-center mt-4" id="story-toggle-container">
        <button type="button" class="btn btn-outline-primary" id="toggle-stories-btn">
          <i class="fas fa-chevron-down me-2"></i>View All Stories
        </button>
      </div>
      {% endif %}
      
      {% endwith %}
    </div>
  </div>
</section>

<!-- Create Story Modal -->
<div class="modal fade" id="storyFormModal" tabindex="-1" aria-labelledby="storyFormModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="storyFormModalLabel">
          <i class="fas fa-book-open me-2 text-primary"></i>Share a Story
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="story-form" method="POST">
          {% csrf_token %}
          <div class="mb-3">
            <label for="story-author-name" class="form-label">Your Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="story-author-name" name="author_name" 
                   placeholder="Enter your name" required maxlength="100">
          </div>
          <div class="mb-3">
            <label for="story-title" class="form-label">Story Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="story-title" name="title" 
                   placeholder="Give your story a title" required maxlength="200">
          </div>
          <div class="mb-3">
            <label for="story-content" class="form-label">Your Story <span class="text-danger">*</span></label>
            <textarea class="form-control" id="story-content" name="content" rows="8" 
                      placeholder="Share your story or memory..." required maxlength="5000"></textarea>
            <div class="form-text">Maximum 5000 characters</div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane me-2"></i>Submit Story
            </button>
          </div>
          <p class="text-muted small mt-3 mb-0 text-center">
            <i class="fas fa-info-circle me-1"></i>
            Your story will be reviewed before appearing publicly.
          </p>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Story Modal -->
<div class="modal fade" id="editStoryModal" tabindex="-1" aria-labelledby="editStoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="editStoryModalLabel">
          <i class="fas fa-edit me-2 text-primary"></i>Edit Story
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-story-form" method="POST">
          {% csrf_token %}
          <input type="hidden" id="edit-story-id" name="story_id">
          <div class="mb-3">
            <label for="edit-story-author-name" class="form-label">Your Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="edit-story-author-name" name="author_name" 
                   required maxlength="100">
          </div>
          <div class="mb-3">
            <label for="edit-story-title" class="form-label">Story Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="edit-story-title" name="title" 
                   required maxlength="200">
          </div>
          <div class="mb-3">
            <label for="edit-story-content" class="form-label">Your Story <span class="text-danger">*</span></label>
            <textarea class="form-control" id="edit-story-content" name="content" rows="8" 
                      required maxlength="5000"></textarea>
            <div class="form-text">Maximum 5000 characters</div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

  {# ======================== QR CODE SECTION ======================== #}
  <div class="qr-code-section">
    <h3>Share This Memorial</h3>
    <p class="qr-instructions">
      Scan this QR code to visit this memorial from another device
    </p>
    
    {% if memorial.qr_code_public_id %}
      <div class="qr-code-container">
        <img src="{{ memorial.get_qr_code_url }}" 
             alt="QR Code for {{ memorial.first_name }} {{ memorial.last_name }}"
             class="qr-code-image"
             id="qrCodeImage"
             onerror="this.style.display='none'; console.error('Failed to load QR code')">
      </div>
      <br>
      <button class="qr-download-btn" 
              id="downloadQrBtn" 
              data-qr-url="{{ memorial.get_qr_code_url }}">
        <i class="fas fa-download"></i> Download QR Code
      </button>
    {% else %}
        <p class="text-muted">QR code not available</p>
    {% endif %}
   </div>


{% endblock %}

{% block extra_js %}
<script>
/**
 * Memorial Detail Page - Complete JavaScript
 * Handles tributes, stories, sharing, gallery, and QR code functionality
 * 
 * Visibility Rules:
 * - Shows all APPROVED tributes/stories to everyone
 * - Shows PENDING tributes/stories ONLY to the author who submitted them
 * - Edit/Delete buttons only appear for user's own tributes/stories
 */

document.addEventListener('DOMContentLoaded', () => {
  
  // ========================
  // === HELPER FUNCTIONS ===
  // ========================
  
  /**
   * Get CSRF token from cookies or hidden input
   */
  function getCsrfToken() {
    // Try cookie first
    const cookieValue = document.cookie
      .split('; ')
      .find(row => row.startsWith('csrftoken='))
      ?.split('=')[1];
    
    if (cookieValue) return cookieValue;
    
    // Fallback to hidden input
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  }
  
  /**
   * Escape HTML to prevent XSS
   */
  function escapeHTML(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  
  /**
   * Show toast notification
   */
  function showToast(message, type = 'success') {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
      toastContainer.style.zIndex = '9999';
      document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.style.minWidth = '300px';
    toast.style.marginBottom = '10px';
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
          ${escapeHTML(message)}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 4000);
  }
  
  // ========================
  // === TRIBUTES SECTION ===
  // ========================
  
  const tributesSection = document.querySelector('.tributes-section');
  
  if (tributesSection) {
    const memorialId = tributesSection.dataset.memorialId;
    const csrfToken = getCsrfToken();
    
    // Get elements
    const tributeFormModalEl = document.getElementById('tributeFormModal');
    const editTributeModalEl = document.getElementById('editTributeModal');
    const tributeForm = document.getElementById('tribute-form');
    const editTributeForm = document.getElementById('edit-tribute-form');
    const tributeList = document.getElementById('tribute-list');
    const visibleTributes = document.getElementById('visible-tributes');
    
    // Initialize modals
    let tributeFormModal = null;
    let editTributeModal = null;
    
    if (tributeFormModalEl) {
      tributeFormModal = bootstrap.Modal.getOrCreateInstance(tributeFormModalEl);
    }
    if (editTributeModalEl) {
      editTributeModal = bootstrap.Modal.getOrCreateInstance(editTributeModalEl);
    }
    
    // Setup toggle button for showing more tributes
    setupTributeToggle();
    
    /**
     * Generate HTML for a tribute card
     */
    function generateTributeCard(tribute, canEdit = false) {
      const isPending = tribute.status === 'pending';
      
      return `
        <div class="col-12 tribute-item" data-tribute-id="${tribute.id}" data-status="${tribute.status}">
          <div class="card tribute-card h-100 border-0 shadow-sm ${isPending ? 'tribute-pending' : ''}">
            <div class="card-body d-flex flex-column p-4">
              ${isPending ? `
                <div class="pending-notice mb-3">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i> Awaiting Approval
                  </span>
                  <small class="text-muted d-block mt-1">
                    Only you can see this tribute until it's approved.
                  </small>
                </div>
              ` : ''}
              
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="tribute-author d-flex align-items-center">
                  <div class="author-avatar me-3">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="author-info">
                    <h3 class="card-title mb-0 fs-5 fw-semibold">${escapeHTML(tribute.author_name)}</h3>
                    <small class="text-muted">${tribute.created_at}</small>
                  </div>
                </div>
              </div>
              
              <div class="card-text flex-grow-1 mb-3 lh-base tribute-message">
                ${escapeHTML(tribute.message).replace(/\n/g, '<br>')}
              </div>
              
              ${canEdit ? `
                <div class="mt-auto pt-3 border-top tribute-actions">
                  <button class="btn btn-sm btn-outline-primary edit-tribute me-2" 
                          data-tribute-id="${tribute.id}"
                          data-author-name="${escapeHTML(tribute.author_name)}"
                          data-message="${escapeHTML(tribute.message)}"
                          aria-label="Edit tribute">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-tribute" 
                          data-tribute-id="${tribute.id}"
                          aria-label="Delete tribute">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }
    
    /**
     * Setup toggle button for viewing more tributes
     */
    function setupTributeToggle() {
      const hiddenTributes = document.getElementById('hidden-tributes');
      const toggleBtn = document.getElementById('toggle-tributes-btn');
      
      if (hiddenTributes && toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          const isHidden = hiddenTributes.classList.contains('d-none');
          hiddenTributes.classList.toggle('d-none');
          
          this.innerHTML = isHidden 
            ? '<i class="fas fa-chevron-up me-2"></i>View Less'
            : '<i class="fas fa-chevron-down me-2"></i>View All Tributes';
        });
      }
    }
    
    /**
     * Handle opening tribute form modal
     */
    const openTributeFormBtn = document.getElementById('open-tribute-form');
    if (openTributeFormBtn && tributeForm) {
      openTributeFormBtn.addEventListener('click', () => {
        tributeForm.reset();
        tributeForm.action = `/memorials/${memorialId}/tributes/create/`;
        tributeFormModal?.show();
      });
    }
    
    /**
     * Handle tribute form submission
     */
    if (tributeForm) {
      tributeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(tributeForm);
        const submitBtn = tributeForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        // Validate form data
        const authorName = formData.get('author_name')?.trim();
        const message = formData.get('message')?.trim();
        
        if (!authorName) {
          showToast('Please enter your name', 'error');
          return;
        }
        if (!message) {
          showToast('Please enter a message', 'error');
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
        
        try {
          const response = await fetch(tributeForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
          });
          
          const responseText = await response.text();
          console.log('Server response:', responseText);
          
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Failed to parse JSON:', responseText);
            throw new Error('Server returned invalid response');
          }
          
          if (data.success) {
            // Remove empty message if it exists
            document.getElementById('empty-tributes-message')?.remove();
            
            // Add new tribute to the list
            const newTributeHTML = generateTributeCard(data.tribute, data.can_edit);
            
            if (visibleTributes) {
              visibleTributes.insertAdjacentHTML('afterbegin', newTributeHTML);
            } else if (tributeList) {
              tributeList.insertAdjacentHTML('afterbegin', newTributeHTML);
            }
            
            tributeFormModal?.hide();
            tributeForm.reset();
            
            showToast(data.message || 'Your tribute has been submitted!', 'success');
          } else {
            throw new Error(data.error || 'Failed to submit tribute');
          }
        } catch (error) {
          console.error('Tribute submission error:', error);
          showToast(error.message || 'An error occurred. Please try again.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });
    }
    
    /**
     * Handle tribute list click events (edit/delete)
     */
    if (tributeList) {
      tributeList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-tribute');
        const deleteBtn = e.target.closest('.delete-tribute');
        
        if (editBtn && editTributeForm) {
          document.getElementById('edit-tribute-id').value = editBtn.dataset.tributeId;
          document.getElementById('edit-tribute-author-name').value = editBtn.dataset.authorName;
          document.getElementById('edit-tribute-message').value = editBtn.dataset.message;
          
          editTributeForm.action = `/memorials/tributes/${editBtn.dataset.tributeId}/edit/`;
          
          editTributeModal?.show();
        }
        
        if (deleteBtn) {
          if (confirm('Are you sure you want to delete your tribute? This action cannot be undone.')) {
            deleteTribute(deleteBtn.dataset.tributeId);
          }
        }
      });
    }
    
    /**
     * Handle edit tribute form submission
     */
    if (editTributeForm) {
      editTributeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(editTributeForm);
        const tributeId = formData.get('tribute_id');
        const submitBtn = editTributeForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        
        try {
          const response = await fetch(editTributeForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
          });
          
          const data = await response.json();
          
          if (data.success) {
            const tributeEl = document.querySelector(`.tribute-item[data-tribute-id="${tributeId}"]`);
            if (tributeEl) {
              tributeEl.outerHTML = generateTributeCard(data.tribute, data.can_edit);
            }
            
            editTributeModal?.hide();
            showToast('Your tribute has been updated.', 'success');
          } else {
            throw new Error(data.error || 'Failed to update tribute');
          }
        } catch (error) {
          console.error('Tribute edit error:', error);
          showToast(error.message || 'An error occurred. Please try again.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });
    }
    
    /**
     * Delete a tribute
     */
    async function deleteTribute(tributeId) {
      try {
        const response = await fetch(`/memorials/tributes/${tributeId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.querySelector(`.tribute-item[data-tribute-id="${tributeId}"]`)?.remove();
          
          // Show empty state if no tributes left
          if (!document.querySelector('.tribute-item')) {
            const container = visibleTributes || tributeList;
            if (container) {
              container.innerHTML = `
                <div class="col-12" id="empty-tributes-message">
                  <div class="empty-tributes text-center py-5">
                    <i class="fas fa-heart fa-3x text-muted mb-4" style="opacity: 0.3;"></i>
                    <h3 class="h5 text-muted mb-3">No tributes yet</h3>
                    <p class="text-muted mb-4">Be the first to share your memories and pay tribute.</p>
                  </div>
                </div>
              `;
            }
          }
          
          showToast('Your tribute has been deleted.', 'success');
        } else {
          throw new Error(data.error || 'Failed to delete tribute');
        }
      } catch (error) {
        console.error('Tribute delete error:', error);
        showToast(error.message || 'An error occurred. Please try again.', 'error');
      }
    }
  }
  
  // ========================
  // === STORIES SECTION ===
  // ========================
  
  const storiesSection = document.querySelector('.stories-section');
  
  if (storiesSection) {
    const memorialId = storiesSection.dataset.memorialId;
    const csrfToken = getCsrfToken();
    
    // Get elements
    const storyFormModalEl = document.getElementById('storyFormModal');
    const editStoryModalEl = document.getElementById('editStoryModal');
    const storyForm = document.getElementById('story-form');
    const editStoryForm = document.getElementById('edit-story-form');
    const storyList = document.getElementById('story-list');
    const visibleStories = document.getElementById('visible-stories');
    
    // Initialize modals
    let storyFormModal = null;
    let editStoryModal = null;
    
    if (storyFormModalEl) {
      storyFormModal = bootstrap.Modal.getOrCreateInstance(storyFormModalEl);
    }
    if (editStoryModalEl) {
      editStoryModal = bootstrap.Modal.getOrCreateInstance(editStoryModalEl);
    }
    
    // Setup toggle button for showing more stories
    setupStoryToggle();
    
    /**
     * Generate HTML for a story card
     */
    function generateStoryCard(story, canEdit = false) {
      const isPending = story.status === 'pending';
      
      return `
        <div class="col-12 story-item" data-story-id="${story.id}" data-status="${story.status}">
          <div class="card story-card h-100 border-0 shadow-sm ${isPending ? 'story-pending' : ''}">
            <div class="card-body d-flex flex-column p-4">
              ${isPending ? `
                <div class="pending-notice mb-3">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i> Awaiting Approval
                  </span>
                  <small class="text-muted d-block mt-1">
                    Only you can see this story until it's approved.
                  </small>
                </div>
              ` : ''}
              
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="story-header-info">
                  <h3 class="card-title mb-1 fs-5 fw-semibold story-title-text">${escapeHTML(story.title)}</h3>
                  <p class="text-muted mb-0 story-author-text">
                    <i class="fas fa-user me-1"></i> by ${escapeHTML(story.author_name)}
                  </p>
                </div>
                <small class="text-muted story-date">${story.created_at}</small>
              </div>
              
              <div class="card-text flex-grow-1 mb-3 lh-base story-content">
                ${escapeHTML(story.content).replace(/\n/g, '<br>')}
              </div>
              
              ${canEdit ? `
                <div class="mt-auto pt-3 border-top story-actions">
                  <button class="btn btn-sm btn-outline-primary edit-story me-2" 
                          data-story-id="${story.id}"
                          data-author-name="${escapeHTML(story.author_name)}"
                          data-title="${escapeHTML(story.title)}"
                          data-content="${escapeHTML(story.content)}"
                          aria-label="Edit story">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-story" 
                          data-story-id="${story.id}"
                          aria-label="Delete story">
                    <i class="fas fa-trash me-1"></i> Delete
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }
    
    /**
     * Setup toggle button for viewing more stories
     */
    function setupStoryToggle() {
      const hiddenStories = document.getElementById('hidden-stories');
      const toggleBtn = document.getElementById('toggle-stories-btn');
      
      if (hiddenStories && toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          const isHidden = hiddenStories.classList.contains('d-none');
          hiddenStories.classList.toggle('d-none');
          
          this.innerHTML = isHidden 
            ? '<i class="fas fa-chevron-up me-2"></i>View Less'
            : '<i class="fas fa-chevron-down me-2"></i>View All Stories';
        });
      }
    }
    
    /**
     * Handle opening story form modal
     */
    const openStoryFormBtn = document.getElementById('open-story-form');
    if (openStoryFormBtn && storyForm) {
      openStoryFormBtn.addEventListener('click', () => {
        storyForm.reset();
        storyForm.action = `/memorials/${memorialId}/stories/create/`;
        storyFormModal?.show();
      });
    }
    
    /**
     * Handle story form submission
     */
    if (storyForm) {
      storyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(storyForm);
        const submitBtn = storyForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        // Validate form data
        const authorName = formData.get('author_name')?.trim();
        const title = formData.get('title')?.trim();
        const content = formData.get('content')?.trim();
        
        if (!authorName) {
          showToast('Please enter your name', 'error');
          return;
        }
        if (!title) {
          showToast('Please enter a title', 'error');
          return;
        }
        if (!content) {
          showToast('Please enter your story', 'error');
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
        
        try {
          const response = await fetch(storyForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
          });
          
          const responseText = await response.text();
          console.log('Server response:', responseText);
          
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Failed to parse JSON:', responseText);
            throw new Error('Server returned invalid response');
          }
          
          if (data.success) {
            // Remove empty message if it exists
            document.getElementById('empty-stories-message')?.remove();
            
            // Add new story to the list
            const newStoryHTML = generateStoryCard(data.story, data.can_edit);
            
            if (visibleStories) {
              visibleStories.insertAdjacentHTML('afterbegin', newStoryHTML);
            } else if (storyList) {
              storyList.insertAdjacentHTML('afterbegin', newStoryHTML);
            }
            
            storyFormModal?.hide();
            storyForm.reset();
            
            showToast(data.message || 'Your story has been submitted!', 'success');
          } else {
            throw new Error(data.error || 'Failed to submit story');
          }
        } catch (error) {
          console.error('Story submission error:', error);
          showToast(error.message || 'An error occurred. Please try again.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });
    }
    
    /**
     * Handle story list click events (edit/delete)
     */
    if (storyList) {
      storyList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-story');
        const deleteBtn = e.target.closest('.delete-story');
        
        if (editBtn && editStoryForm) {
          document.getElementById('edit-story-id').value = editBtn.dataset.storyId;
          document.getElementById('edit-story-author-name').value = editBtn.dataset.authorName;
          document.getElementById('edit-story-title').value = editBtn.dataset.title;
          document.getElementById('edit-story-content').value = editBtn.dataset.content;
          
          editStoryForm.action = `/memorials/stories/${editBtn.dataset.storyId}/edit/`;
          
          editStoryModal?.show();
        }
        
        if (deleteBtn) {
          if (confirm('Are you sure you want to delete your story? This action cannot be undone.')) {
            deleteStory(deleteBtn.dataset.storyId);
          }
        }
      });
    }
    
    /**
     * Handle edit story form submission
     */
    if (editStoryForm) {
      editStoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(editStoryForm);
        const storyId = formData.get('story_id');
        const submitBtn = editStoryForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        
        try {
          const response = await fetch(editStoryForm.action, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
          });
          
          const data = await response.json();
          
          if (data.success) {
            const storyEl = document.querySelector(`.story-item[data-story-id="${storyId}"]`);
            if (storyEl) {
              storyEl.outerHTML = generateStoryCard(data.story, data.can_edit);
            }
            
            editStoryModal?.hide();
            showToast('Your story has been updated.', 'success');
          } else {
            throw new Error(data.error || 'Failed to update story');
          }
        } catch (error) {
          console.error('Story edit error:', error);
          showToast(error.message || 'An error occurred. Please try again.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });
    }
    
    /**
     * Delete a story
     */
    async function deleteStory(storyId) {
      try {
        const response = await fetch(`/memorials/stories/${storyId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
          },
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.querySelector(`.story-item[data-story-id="${storyId}"]`)?.remove();
          
          // Show empty state if no stories left
          if (!document.querySelector('.story-item')) {
            const container = visibleStories || storyList;
            if (container) {
              container.innerHTML = `
                <div class="col-12" id="empty-stories-message">
                  <div class="empty-stories text-center py-5">
                    <i class="fas fa-book-open fa-3x text-muted mb-4" style="opacity: 0.3;"></i>
                    <h3 class="h5 text-muted mb-3">No stories yet</h3>
                    <p class="text-muted mb-4">Be the first to share a story or memory.</p>
                  </div>
                </div>
              `;
            }
          }
          
          showToast('Your story has been deleted.', 'success');
        } else {
          throw new Error(data.error || 'Failed to delete story');
        }
      } catch (error) {
        console.error('Story delete error:', error);
        showToast(error.message || 'An error occurred. Please try again.', 'error');
      }
    }
  }
  
  // ==============================
  // === GALLERY FUNCTIONALITY ===
  // ==============================
  
  const galleryModal = document.getElementById('galleryModal');
  
  if (galleryModal) {
    const galleryCarouselEl = document.getElementById('galleryCarousel');
    if (galleryCarouselEl) {
      const galleryCarousel = bootstrap.Carousel.getOrCreateInstance(galleryCarouselEl);

      galleryModal.addEventListener('show.bs.modal', function (event) {
        const trigger = event.relatedTarget;
        const slideIndex = trigger?.getAttribute('data-bs-slide-to');
        if (slideIndex !== null) {
          galleryCarousel.to(parseInt(slideIndex));
        }
      });
    }

    // Toggle gallery hidden/visible photos
    const toggleGalleryBtn = document.getElementById('toggle-gallery-btn');
    if (toggleGalleryBtn) {
      toggleGalleryBtn.addEventListener('click', function() {
        const hiddenGallery = document.getElementById('hidden-gallery');
        if (hiddenGallery) {
          const isHidden = hiddenGallery.classList.contains('d-none');
          hiddenGallery.classList.toggle('d-none');
          this.innerHTML = isHidden 
            ? '<i class="fas fa-chevron-up me-2"></i>View Less'
            : '<i class="fas fa-chevron-down me-2"></i>View More';
        }
      });
    }
  }
});

// ================================
// === SHARING FUNCTIONALITY ===
// ================================

document.getElementById("shareButton")?.addEventListener("click", function () {
  const shareData = {
    title: document.title,
    text: "Visit this memorial page:",
    url: window.location.href
  };

  if (navigator.share) {
    navigator.share(shareData)
      .then(() => console.log('Memorial shared successfully'))
      .catch((error) => console.error('Error sharing memorial:', error));
  } else {
    navigator.clipboard.writeText(window.location.href)
      .then(() => {
        // Show toast notification
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
          toastContainer.style.zIndex = '9999';
          document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast show align-items-center text-white bg-success border-0';
        toast.style.minWidth = '300px';
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas fa-check-circle me-2"></i>
              Link copied to clipboard!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
          </div>
        `;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      })
      .catch(() => alert("Couldn't copy the link. Please try manually."));
  }
});

// ================================
// === QR CODE DOWNLOAD ===
// ================================

document.addEventListener('DOMContentLoaded', function() {
  const downloadQrBtn = document.getElementById('downloadQrBtn');
  
  if (downloadQrBtn) {
    downloadQrBtn.addEventListener('click', async function() {
      const qrCodeUrl = this.getAttribute('data-qr-url');
      const qrCodeImage = document.getElementById('qrCodeImage');
      
      if (!qrCodeImage || !qrCodeUrl) {
        console.error('QR code image or URL not found');
        alert('Unable to download QR code. Please try again.');
        return;
      }
      
      try {
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
        this.disabled = true;
        
        const response = await fetch(qrCodeUrl);
        if (!response.ok) throw new Error('Failed to fetch QR code');
        
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        
        const downloadLink = document.createElement('a');
        downloadLink.href = blobUrl;
        downloadLink.download = 'memorial_qr_code.png';
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        URL.revokeObjectURL(blobUrl);
        
        this.innerHTML = originalText;
        this.disabled = false;
        
      } catch (error) {
        console.error('Download error:', error);
        
        // Fallback method
        try {
          const fallbackLink = document.createElement('a');
          fallbackLink.href = qrCodeUrl;
          fallbackLink.download = 'memorial_qr_code.png';
          document.body.appendChild(fallbackLink);
          fallbackLink.click();
          document.body.removeChild(fallbackLink);
        } catch (fallbackError) {
          console.error('Fallback download also failed:', fallbackError);
          alert('Failed to download QR code. Please try again.');
        }
        
        this.innerHTML = '<i class="fas fa-download"></i> Download QR Code';
        this.disabled = false;
      }
    });
  }
});
</script>
{% endblock %}